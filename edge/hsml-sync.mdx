---
title: HSML Offline-First Sync
description: Zero data loss synchronization for disconnected humanitarian operations
---

## Overview

The HSML (Health Sovereign Markup Language) Sync Agent enables **0% data loss** during offline humanitarian operations through Vector Clock conflict resolution and intelligent reconciliation.

<Card
  title="Philosophy"
  icon="wifi-slash"
>
  "Sovereign agents operate with dignity even in digital darkness."
</Card>

## Key features

<CardGroup cols={2}>
  <Card title="Vector Clock" icon="clock">
    Distributed conflict resolution without central coordination
  </Card>
  <Card title="Local buffer" icon="database">
    SQLite storage for offline event queuing
  </Card>
  <Card title="Auto-reconciliation" icon="arrows-rotate">
    Automatic sync when connectivity returns
  </Card>
  <Card title="Zero data loss" icon="shield-check">
    Guaranteed delivery with retry logic
  </Card>
</CardGroup>

## Architecture

```
┌─────────────────────────────────────┐
│         EDGE NODE (Offline)         │
│  ┌──────────────────────────────┐  │
│  │  HSML Sync Agent             │  │
│  │  - Vector Clock              │  │
│  │  - SQLite Buffer             │  │
│  │  - Event Queue               │  │
│  └──────────────────────────────┘  │
│              │                      │
│              │ Store locally        │
│              ▼                      │
│  ┌──────────────────────────────┐  │
│  │  hsml_buffer.db              │  │
│  │  - Pending events            │  │
│  │  - Vector clocks             │  │
│  │  - Retry metadata            │  │
│  └──────────────────────────────┘  │
└─────────────────────────────────────┘
              │
              │ Sync when online
              ▼
┌─────────────────────────────────────┐
│         GOLDEN THREAD               │
│  - Conflict detection               │
│  - Three-way merge                  │
│  - Verified timeline                │
└─────────────────────────────────────┘
```

## Vector Clock conflict resolution

### How it works

Each node maintains a vector of logical timestamps. When events are created offline, they're tagged with the current vector clock. When syncing, conflicts are detected by comparing vector clocks.

```python
from edge_node.sync_agent import HSMLSyncAgent, EventType, VectorClock

# Initialize agent
agent = HSMLSyncAgent(node_id="JOR-47")

# Create event (increments vector clock)
event = agent.create_event(
    event_type=EventType.CBS_REPORT,
    payload={
        "location": "Dadaab",
        "symptom": "diarrhea",
        "severity": 8
    }
)

# Vector clock: {"JOR-47": 1}
print(event.vector_clock.to_dict())
```

### Conflict detection

```python
# Event A: {"JOR-47": 1}
# Event B: {"JOR-47": 2}
# Result: B happens-after A (no conflict)

# Event A: {"JOR-47": 1, "JOR-48": 0}
# Event B: {"JOR-47": 0, "JOR-48": 1}
# Result: Concurrent events (conflict!)
```

## Basic usage

### Initialize sync agent

```python
from edge_node.sync_agent import HSMLSyncAgent, EventType

agent = HSMLSyncAgent(
    node_id="JOR-47",
    db_path="./hsml_buffer.db",
    max_retry_attempts=5,
    retry_backoff_seconds=60
)
```

### Create offline events

```python
# CBS report from CHV
cbs_event = agent.create_event(
    event_type=EventType.CBS_REPORT,
    payload={
        "location": "Dadaab",
        "symptom": "diarrhea",
        "severity": 8,
        "reporter": "CHV_AMINA_HASSAN"
    }
)

# Voice alert
voice_event = agent.create_event(
    event_type=EventType.VOICE_ALERT,
    payload={
        "location": "Dadaab",
        "transcription": "Patient reporting severe dehydration",
        "language": "swahili"
    }
)

# Sensor reading
sensor_event = agent.create_event(
    event_type=EventType.SENSOR_READING,
    payload={
        "location": "Dadaab",
        "temperature": 38.5,
        "humidity": 0.65
    }
)
```

### Check buffer status

```python
# Get pending events
pending = agent.get_pending_events(limit=100)
print(f"Pending events: {len(pending)}")

# Get buffer statistics
stats = agent.get_buffer_stats()
print(f"Total: {stats['total']}")
print(f"Pending: {stats.get('pending', 0)}")
print(f"Synced: {stats.get('synced', 0)}")
print(f"Failed: {stats.get('failed', 0)}")
```

### Sync to Golden Thread

```python
# When connectivity returns
from edge_node.sync_protocol.golden_thread import GoldenThread

golden_thread = GoldenThread()

# Sync pending events
sync_stats = agent.sync_to_golden_thread(
    golden_thread_client=golden_thread,
    batch_size=50
)

print(f"Synced: {sync_stats['synced']}")
print(f"Conflicts: {sync_stats['conflicts']}")
print(f"Failed: {sync_stats['failed']}")
```

## Conflict reconciliation

### Automatic resolution

The HSML Reconciler automatically resolves conflicts using intelligent strategies:

```python
from edge_node.hsml_reconciler import HSMLReconciler

reconciler = HSMLReconciler(
    auto_resolve_threshold=0.8,
    enable_semantic_analysis=True
)

# Reconcile conflicting events
report = reconciler.reconcile(local_event, remote_event)

print(f"Conflict type: {report.conflict_type}")
print(f"Strategy: {report.resolution_strategy}")
print(f"Confidence: {report.confidence_score}")
print(f"Manual review: {report.requires_manual_review}")
```

### Resolution strategies

| Strategy | Use Case | Confidence |
|----------|----------|------------|
| **Last Write Wins** | Timestamp conflicts | 0.9 |
| **Highest Severity** | Medical severity conflicts | 0.85 |
| **Merge Payloads** | Non-conflicting fields | 0.5-1.0 |
| **Most Complete** | Missing data conflicts | 0.8 |
| **Manual Review** | Semantic conflicts | 0.0 |

### Example: Severity conflict

```python
# Local event: severity = 8
local_event = {
    "event_id": "local_001",
    "timestamp": "2025-12-23T10:00:00Z",
    "payload": {
        "location": "Dadaab",
        "symptom": "diarrhea",
        "severity": 8
    }
}

# Remote event: severity = 9
remote_event = {
    "event_id": "remote_001",
    "timestamp": "2025-12-23T10:05:00Z",
    "payload": {
        "location": "Dadaab",
        "symptom": "diarrhea",
        "severity": 9
    }
}

# Reconcile (uses HIGHEST_SEVERITY strategy)
report = reconciler.reconcile(local_event, remote_event)

# Result: severity = 9 (err on side of caution)
```

## Event types

```python
class EventType(Enum):
    CBS_REPORT = "cbs_report"           # Community-based surveillance
    EMR_RECORD = "emr_record"           # Electronic medical record
    IDSR_SUBMISSION = "idsr_submission" # Government reporting
    VOICE_ALERT = "voice_alert"         # CHV voice note
    SENSOR_READING = "sensor_reading"   # IoT sensor data
    OUTBREAK_ALERT = "outbreak_alert"   # AI-generated alert
```

## Sync status

```python
class SyncStatus(Enum):
    PENDING = "pending"         # Waiting to sync
    IN_PROGRESS = "in_progress" # Currently syncing
    SYNCED = "synced"           # Successfully synced
    CONFLICT = "conflict"       # Requires reconciliation
    FAILED = "failed"           # Max retries exceeded
```

## Performance

- **Event creation:** <10ms
- **Local storage:** <50ms
- **Sync throughput:** 100+ events/second
- **Conflict resolution:** <100ms per conflict
- **Database size:** ~1KB per event

## Compliance

The HSML Sync Agent enforces sovereignty constraints:

```python
from governance_kernel.vector_ledger import SovereignGuardrail

guardrail = SovereignGuardrail()

# Validate sync operation
guardrail.validate_action(
    action_type='Data_Sync',
    payload={
        'data_type': 'PHI',
        'source': 'Edge_Node',
        'destination': 'Golden_Thread',
        'consent_token': 'VALID_TOKEN'
    },
    jurisdiction='KDPA_KE'
)
```

**Compliance frameworks:**
- GDPR Art. 32 (Security of Processing)
- HIPAA §164.312(b) (Audit Controls)
- ISO 27001 A.12.4 (Logging and Monitoring)

## Monitoring

### Metrics

```python
# Buffer metrics
stats = agent.get_buffer_stats()

# Prometheus metrics
hsml_events_pending{node_id="JOR-47"} 42
hsml_events_synced_total{node_id="JOR-47"} 1523
hsml_events_failed_total{node_id="JOR-47"} 3
hsml_sync_conflicts_total{node_id="JOR-47"} 7
```

### Alerts

Configure alerts for:
- High pending event count (>1000)
- Failed sync attempts (>10)
- Conflict rate (>5%)
- Buffer size (>100MB)

## Best practices

<AccordionGroup>
  <Accordion title="Batch sync operations">
    Sync in batches of 50-100 events to optimize network usage
  </Accordion>
  <Accordion title="Monitor buffer size">
    Alert when buffer exceeds 1000 events or 100MB
  </Accordion>
  <Accordion title="Handle conflicts promptly">
    Review manual conflicts within 24 hours
  </Accordion>
  <Accordion title="Test offline scenarios">
    Regularly test offline operation and sync recovery
  </Accordion>
  <Accordion title="Backup buffer database">
    Daily backups of hsml_buffer.db to prevent data loss
  </Accordion>
</AccordionGroup>

## Troubleshooting

### Issue: Database locked

**Cause:** Multiple processes accessing hsml_buffer.db

**Solution:**
```python
# Ensure proper connection cleanup
agent = HSMLSyncAgent(node_id="JOR-47")
# ... use agent ...
# Connection auto-closes when agent goes out of scope
```

### Issue: High conflict rate

**Cause:** Multiple nodes editing same records

**Solution:**
- Implement node-specific record ownership
- Use conflict-free data types (CRDTs)
- Increase sync frequency

### Issue: Sync failures

**Cause:** Network issues or Golden Thread unavailable

**Solution:**
```python
# Check retry configuration
agent = HSMLSyncAgent(
    node_id="JOR-47",
    max_retry_attempts=10,  # Increase retries
    retry_backoff_seconds=120  # Longer backoff
)
```

## Next steps

<CardGroup cols={2}>
  <Card
    title="Offline operations"
    icon="wifi-slash"
    href="/edge/offline-operations"
  >
    Complete guide to offline mode
  </Card>
  <Card
    title="Golden Thread"
    icon="link"
    href="/architecture/golden-thread"
  >
    Understand data fusion logic
  </Card>
  <Card
    title="AI agents"
    icon="brain-circuit"
    href="/ai-agents/overview"
  >
    Deploy autonomous surveillance
  </Card>
  <Card
    title="Compliance"
    icon="shield-check"
    href="/compliance/overview"
  >
    Compliance enforcement
  </Card>
</CardGroup>
