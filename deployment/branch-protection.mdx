---
title: Branch protection setup
description: Configure GitHub branch protection for the Sovereign Health Fortress
---

## Overview

Branch protection ensures that all code changes pass security scans (CodeQL, Gitleaks) and compliance checks before merging to production.

<Card
  title="Security principle"
  icon="shield-check"
>
  "The Fortress is continuously attested. No code enters without validation."
</Card>

## Prerequisites

Ensure you have the required permissions:

```bash
gh auth refresh -s workflow,repo,write:packages,admin:repo_hook
```

## Automated setup

### Using GitHub CLI

```bash
# Enable branch protection on main
gh api repos/VISENDI56/iLuminara-Core/branches/main/protection \
  --method PUT \
  --field required_status_checks[strict]=true \
  --field required_status_checks[contexts][]=CodeQL \
  --field required_status_checks[contexts][]=Gitleaks \
  --field enforce_admins=true \
  --field required_pull_request_reviews[required_approving_review_count]=1 \
  --field required_pull_request_reviews[dismiss_stale_reviews]=true \
  --field required_pull_request_reviews[require_code_owner_reviews]=true \
  --field restrictions=null
```

### Using script

Create `scripts/setup_branch_protection.sh`:

```bash
#!/bin/bash

set -e

REPO="VISENDI56/iLuminara-Core"
BRANCH="main"

echo "üõ°Ô∏è Setting up branch protection for ${REPO}:${BRANCH}"

# Enable branch protection
gh api repos/${REPO}/branches/${BRANCH}/protection \
  --method PUT \
  --input - <<EOF
{
  "required_status_checks": {
    "strict": true,
    "contexts": [
      "CodeQL",
      "Gitleaks",
      "build"
    ]
  },
  "enforce_admins": true,
  "required_pull_request_reviews": {
    "dismissal_restrictions": {},
    "dismiss_stale_reviews": true,
    "require_code_owner_reviews": true,
    "required_approving_review_count": 1,
    "require_last_push_approval": false
  },
  "restrictions": null,
  "required_linear_history": true,
  "allow_force_pushes": false,
  "allow_deletions": false,
  "block_creations": false,
  "required_conversation_resolution": true,
  "lock_branch": false,
  "allow_fork_syncing": true
}
EOF

echo "‚úÖ Branch protection enabled"
```

Run the script:

```bash
chmod +x scripts/setup_branch_protection.sh
./scripts/setup_branch_protection.sh
```

## Manual setup via GitHub UI

<Steps>
  <Step title="Navigate to settings">
    Go to repository ‚Üí Settings ‚Üí Branches
  </Step>
  <Step title="Add rule">
    Click "Add branch protection rule"
  </Step>
  <Step title="Configure branch name">
    Enter `main` as the branch name pattern
  </Step>
  <Step title="Enable required checks">
    Check "Require status checks to pass before merging"
    - Select "CodeQL"
    - Select "Gitleaks"
    - Check "Require branches to be up to date before merging"
  </Step>
  <Step title="Enable pull request reviews">
    Check "Require a pull request before merging"
    - Set "Required approving reviews" to 1
    - Check "Dismiss stale pull request approvals when new commits are pushed"
    - Check "Require review from Code Owners"
  </Step>
  <Step title="Additional protections">
    - Check "Require linear history"
    - Check "Require conversation resolution before merging"
    - Uncheck "Allow force pushes"
    - Uncheck "Allow deletions"
  </Step>
  <Step title="Save">
    Click "Create" to save the protection rule
  </Step>
</Steps>

## Protection rules

### Required status checks

| Check | Purpose | Compliance |
|-------|---------|------------|
| **CodeQL** | SAST security scanning | GDPR Art. 32, ISO 27001 A.12.6 |
| **Gitleaks** | Secret detection | NIST SP 800-53 IA-5 |
| **Build** | Compilation and tests | SOC 2 (Processing Integrity) |

### Pull request requirements

- **1 approving review** - Peer review required
- **Dismiss stale reviews** - Re-review after new commits
- **Code owner review** - Domain experts must approve
- **Conversation resolution** - All comments must be resolved

### Additional protections

- **Linear history** - No merge commits (rebase only)
- **No force pushes** - Prevents history rewriting
- **No deletions** - Branch cannot be deleted
- **Up-to-date branches** - Must merge latest main before PR

## CODEOWNERS file

Create `.github/CODEOWNERS` to enforce domain expert reviews:

```
# iLuminara-Core Code Owners
# These owners will be requested for review when someone opens a pull request.

# Global owners
* @VISENDI56

# Governance Kernel
/governance_kernel/ @VISENDI56 @compliance-team
/config/sovereign_guardrail.yaml @VISENDI56 @compliance-team

# Security workflows
/.github/workflows/codeql.yml @VISENDI56 @security-team
/.github/workflows/gitleaks.yml @VISENDI56 @security-team
/.gitleaks.toml @VISENDI56 @security-team

# AI Agents
/edge_node/ai_agents/ @VISENDI56 @ai-team

# API
/api_service.py @VISENDI56 @backend-team

# Documentation
/docs/ @VISENDI56 @docs-team
*.md @VISENDI56 @docs-team
```

## Workflow integration

Ensure workflows run on pull requests:

```yaml
# .github/workflows/codeql.yml
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]  # ‚Üê Required for branch protection
```

## Bypass protection (emergency only)

In emergencies, admins can bypass protection:

```bash
# Temporarily disable protection
gh api repos/VISENDI56/iLuminara-Core/branches/main/protection \
  --method DELETE

# Make emergency commit
git push origin main

# Re-enable protection
./scripts/setup_branch_protection.sh
```

**‚ö†Ô∏è Warning:** All bypasses are logged in audit trail.

## Verification

Verify branch protection is active:

```bash
# Check protection status
gh api repos/VISENDI56/iLuminara-Core/branches/main/protection

# Expected output:
# {
#   "required_status_checks": {
#     "strict": true,
#     "contexts": ["CodeQL", "Gitleaks"]
#   },
#   "enforce_admins": true,
#   ...
# }
```

## Testing protection

Test that protection works:

```bash
# Try to push directly to main (should fail)
git checkout main
echo "test" >> README.md
git commit -am "test: direct push"
git push origin main

# Expected error:
# remote: error: GH006: Protected branch update failed for refs/heads/main.
# remote: error: Required status check "CodeQL" is expected.
```

## Compliance mapping

Branch protection enforces these compliance requirements:

| Framework | Requirement | Implementation |
|-----------|-------------|----------------|
| **GDPR Art. 32** | Security of Processing | CodeQL SAST scanning |
| **ISO 27001 A.12.6** | Technical Vulnerability Management | Required security checks |
| **SOC 2** | Change Management | Pull request reviews |
| **NIST SP 800-53** | Configuration Management | Linear history, no force pushes |
| **HIPAA ¬ß164.312** | Access Control | Code owner reviews |

## Troubleshooting

### Status checks not appearing

Ensure workflows have run at least once:

```bash
# Trigger workflows manually
gh workflow run codeql.yml
gh workflow run gitleaks.yml
```

### Cannot merge PR

Check that all required checks have passed:

```bash
# View PR status
gh pr view 123 --json statusCheckRollup

# Re-run failed checks
gh run rerun <run-id>
```

### Admin bypass not working

Verify admin permissions:

```bash
# Check your permissions
gh api repos/VISENDI56/iLuminara-Core --jq .permissions
```

## Next steps

<CardGroup cols={2}>
  <Card
    title="Security workflows"
    icon="workflow"
    href="/security/workflows"
  >
    Configure CodeQL and Gitleaks
  </Card>
  <Card
    title="Deployment checklist"
    icon="list-check"
    href="/deployment/checklist"
  >
    Complete deployment checklist
  </Card>
  <Card
    title="Governance"
    icon="shield-check"
    href="/governance/overview"
  >
    Configure compliance enforcement
  </Card>
  <Card
    title="Security overview"
    icon="shield-halved"
    href="/security/overview"
  >
    Review security architecture
  </Card>
</CardGroup>
